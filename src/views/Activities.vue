<template>
  <div>
    <v-card-title>
      我的跑步紀錄
    </v-card-title>
    <v-menu
      v-model="dateMenu"
      :close-on-content-click="false"
      :nudge-right="40"
      transition="scale-transition"
      offset-y
      min-width="auto"
    >
      <template v-slot:activator="{ on, attrs }">
        <v-text-field
          v-model="dateRangeText"
          label="查詢活動"
          prepend-icon="mdi-calendar"
          readonly
          v-bind="attrs"
          v-on="on"
          clearable
          class="mx-4"
          height="35"
          @input="cleardateRangeText"
        ></v-text-field>
      </template>
      <v-date-picker
        v-model="search.date"
        no-title
        scrollable
        range
        locale="zh-tw"
      ></v-date-picker>
    </v-menu>
    <v-card
      class="ma-4"
      v-for="(data, i) in activities"
      :key="`activities_${i}`"
    >
      <RunningInfo :data="data" />
      <v-card-actions>
        <v-spacer></v-spacer>
        <v-btn
          text
          color="cyan"
          @click="routerPush(data.id)"
        >
          查看活動
        </v-btn>
      </v-card-actions>
    </v-card>
    <Loading />
    <NoData />
    <div class="text-center">
      <v-pagination
        v-model="pagination.page"
        :length="pagination.total"
        :total-visible="6"
        circle
      ></v-pagination>
    </div>
  </div>
</template>
<script>
import _ from 'lodash';
import RunningInfo from '../components/RunningInfo.vue';
import NoData from '../components/NoData.vue';
import Loading from '../components/Loading.vue';
// import imgExample from '../assets/Actitivities/activitity_example.png';
import { activities } from '../libs/activities.js';
import { mapState, mapMutations } from 'vuex';

export default {
  name: 'Activities',
  data() {
    return {
      // imgExample,
      dateMenu: false,
      activities: [],
      dateRangeText: null,
      search: {
        date: [],
      },
      pagination: {
        page: 1,
        total: 1,
      },
    };
  },
  components: {
    RunningInfo,
    NoData,
    Loading,
  },
  methods: {
    ...mapMutations([
      'setError',
      'setLoading',
      'setNoData',
    ]),
    routerPush(id) {
      this.$router.push({
        name: 'Activity',
        params: {id},
      });
    },
    getData(id, page) {
      this.setLoading(true);
      this.activities = [];
      activities.getActivities({id, page, ...this.searchData}).then((res) => {
        this.setLoading(false);
        if (res.status) {
          this.setNoData(false);
          this.activities = res.data.data;
          this.pagination = {
            page: res.data.current_page,
            total: res.data.last_page,
          };
        } else {
          this.setError(res.message);
          this.setNoData(true);
          this.pagination = {
            page: 1,
            total: 1,
          };
        }
      });
    },
    cleardateRangeText() {
      this.search.date = [];
      this.dateRangeText = null;
      this.getQuery();
      this.getData(this.loginData.id, 1);
    },
    getDateRangeText () {
      if (this.search.date[0] && this.search.date[1]) {
        this.dateRangeText = this.search.date.join(' ~ ')
        this.getQuery();
        this.getData(this.loginData.id, 1);
      }
    },
    getQuery() {
      const { startDay, endDay } = this.searchData;
      this.$router.push({ params: { page: this.pagination.page }, query: { startDay, endDay } });
    },
    setQuery() {
      const { startDay, endDay } = this.$route.query;
      if (startDay && endDay) {
        this.search.date = [startDay, endDay];
      }
      this.$router.push({ params: { page: this.pagination.page }, query: { startDay, endDay } });
    }
  },
  computed: {
    ...mapState([
      'login',
      'loginData',
    ]),
    searchData() {
      const formData = {};
      Object.keys(this.search).forEach((key) => {
        if (this.search[key] !== null || this.search[key] !== '') {
          if (key === 'date') {
            if (this.search.date[0] && this.search.date[1]) {
              _.set(formData, 'startDay', this.search.date[0]);
              _.set(formData, 'endDay', this.search.date[1]);
            }
          }
        }
      });
      return formData;
    },
  },
  watch: {
    'pagination.page': {
      immediate: true,
      handler(newPage, oldPage) {
        if ((newPage && oldPage) && (newPage !== oldPage)) {
          this.getQuery();
          this.activities = null;
          this.getData(this.loginData.id, newPage);
        }
      },
    },
    'search.date': {
      handler() {
        this.getDateRangeText();
      }
    },
  },
  mounted() {
    if (this.login) {
      this.setQuery();
      this.getData(this.loginData.id, this.$route.params?.page ?? 1);
    }
  },
}
</script>